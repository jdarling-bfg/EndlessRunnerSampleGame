@Library('shared') _

pipeline {
    agent { label 'Mac' }
    options {
        timestamps()
    }
    stages {
        stage ('Clean workspace') {
          steps {
            cleanWs()
          }
        }
        stage ('Checkout project') {
          steps {
              script {
                  gitLFS('bfg-git-pat', 'https://github.com/jdarling-bfg/EndlessRunnerSampleGame.git', '*/unity_build')
              }
          }
        }
//         stage ('Sonar (Disabled)') {
//             steps {
//                 script {
//                     common.runSonarQube('.', 'sonar-project-key', 'AIM')
//                 }
//             }
//         }
    stage('Set Version Number')
    {
      steps {
        script {
          def ver = sh returnStdout:true, script: '''
            #!/bin/bash
            . "${WORKSPACE}"/version.profile
            PATCH_VERSION=$((`git rev-list --count HEAD`-${PATCH_OFFSET}))
            VERSION_NUMBER=$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION
            /bin/echo -n ${VERSION_NUMBER};
          '''
          env.VERSION_NUMBER = ver

          def fullVer = sh returnStdout:true, script: '''
            #!/bin/bash
            if [ "${SAFE_BRANCH_NAME}" = "main" ]; then
              /bin/echo -n ${VERSION_NUMBER}
            else
              /bin/echo -n "${VERSION_NUMBER}-${SAFE_BRANCH_NAME}"
            fi
          '''
          env.FULL_VERSION_NUMBER = fullVer
          env.FINAL_IPA = "PFC_${params.ENVIRONMENT_NAME}_${env.FULL_VERSION_NUMBER}_${params.SIGNING_TYPE}.ipa"

          currentBuild.displayName = "#${env.FULL_VERSION_NUMBER}"

          echo "VERSION_NUMBER: ${env.VERSION_NUMBER}"
          echo "FULL_VERSION_NUMBER: ${env.FULL_VERSION_NUMBER}"
        }
      }
    }
        stage ('Build Unity application') {
            steps {
                withCredentials([string(credentialsId: 'unity-token', variable: 'UNITY_SERIAL')]) {
                    script {
                        try {
//                             sh "/Applications/Unity\\ Hub.app/Contents/MacOS/Unity\\ Hub -quit -batchmode -serial $UNITY_SERIAL -username 'TImothy.Cope@bigfishgames.com' -nographics"
//                             sh "/Applications/Unity\\ Hub.app/Contents/MacOS/Unity\\ Hub -projectPath ${WORKSPACE}/ -buildTarget iOS -batchmode -executeMethod CLBuilder.ReceiveBuildCommand --bundleVersion=${FULL_VERSION_NUMBER} --logFile ${WORKSPACE}/unity3d_editor.log -quit ${BUILD_CONFIG} -nographics"
                            sh "/Applications/Unity/Unity.app/Contents/MacOS/Unity -projectPath . -buildTarget iOS -batchmode -executeMethod CLBuilder.ReceiveBuildCommand --bundleVersion=${FULL_VERSION_NUMBER} --logFile ${WORKSPACE}/unity3d_editor.log -quit ${BUILD_CONFIG} -nographics"
                        } catch (err) {
                            echo "Caught: ${err}"
                            sh '''
                                guidConflicts=$(grep -A 1 "cs' conflicts with" ${WORKSPACE}/unity3d_editor.log)
                                if [ -z "$guidConflicts" ]; then
                                    echo "No GUID conflicts found"
                                else
                                    echo "Found GUID conflicts\n$guidConflicts" 1>&2
                                fi
                            '''
                            currentBuild.result = 'FAILURE'
                            stageResult."${STAGE_NAME}" = 'FAILURE'
                        }
                    }
                }
            }
        }
    }
}

def locateUnity() {
    sh '''
        if [[ "$OSTYPE" == "darwin"* ]] && [ -z "$UNITY_EXECUTABLE" ]; then
            unity_default_path="/Applications/Unity/Hub/Editor/${unity_version}/Unity.app/Contents/MacOS/Unity"
            if [ -f "${unity_default_path}" ]; then
                export UNITY_EXECUTABLE="${unity_default_path}"
                echo "Found 'UNITY_EXECUTABLE': '${UNITY_EXECUTABLE}'"
            else
                echo "Expected to find unity at '${unity_default_path}'. Please ensure Unity is installed and set 'UNITY_EXECUTABLE' env var to its location."
            fi
    '''
}

def gitLFS(credentials, url, branch) {
    checkout([
      $class: 'GitSCM',
      branches: [[name: "${branch}"]],
      doGenerateSubmoduleConfigurations: false,
      extensions: [
        [ $class: 'GitLFSPull' ],
        [
          $class: 'CleanBeforeCheckout',
          deleteUntrackedNestedRepositories: true
        ],
        [
          $class: "CloneOption",
          shallow: false,
          timeout: 40
        ],
        [
          $class: 'PruneStaleBranch'
        ],
      ],
      submoduleCfg: [],
      userRemoteConfigs: [[
        credentialsId: credentials,
        url: url
      ]]
    ])
}